<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>服务实例接口巡检监控</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1.5.0/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
    <style>
        .instance-card { transition: all 0.3s; margin-bottom: 15px; }
        .instance-card:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0,0,0,0.1); }
        .status-up { background-color: #d4edda; }
        .status-down { background-color: #f8d7da; }
        .last-check { font-size: 0.85rem; color: #6c757d; }
    </style>
</head>
<body>
<div class="container-fluid py-4">
    <h1 class="text-center mb-4">服务实例接口巡检监控</h1>

    <div class="row mb-3">
        <div class="col">
            <button id="checkAllBtn" class="btn btn-primary">检查所有实例</button>
            <span class="ms-2 last-check" id="lastUpdateTime">最后更新: --</span>
        </div>
    </div>

    <div class="row" id="instancesContainer">
        <!-- 实例状态卡片将通过JavaScript动态生成 -->
    </div>
</div>

<script>
    // 建立WebSocket连接
    const socket = new SockJS('/ws-instances');
    const stompClient = Stomp.over(socket);

    // 连接成功后的回调
    stompClient.connect({}, function(frame) {
        console.log('Connected: ' + frame);

        // 订阅实例状态更新
        stompClient.subscribe('/topic/instances', function(message) {
            updateInstances(JSON.parse(message.body));
        });

        // 请求初始数据
        stompClient.send("/app/checkAllInstances", {});
    });

    // 更新实例显示
    function updateInstances(instances) {
        const container = document.getElementById('instancesContainer');
        container.innerHTML = '';

        instances.forEach(instance => {
            const card = createInstanceCard(instance);
            container.appendChild(card);
        });

        // 更新最后检查时间
        document.getElementById('lastUpdateTime').textContent =
            `最后更新: ${new Date().toLocaleTimeString()}`;
    }

    // 创建实例卡片
    function createInstanceCard(instance) {
        const col = document.createElement('div');
        col.className = 'col-md-3 col-sm-6';

        const statusClass = instance.status ? 'status-up' : 'status-down';
        const statusText = instance.status ? '正常' : '异常';
        const statusIcon = instance.status ? '✅' : '❌';

        col.innerHTML = `
            <div class="card instance-card ${statusClass}">
                <div class="card-body">
                    <h5 class="card-title">${instance.instanceName}</h5>
                    <h6 class="card-subtitle mb-2 text-muted">${instance.instanceId}</h6>
                    <p class="card-text">
                        <div>状态: ${statusIcon} ${statusText}</div>
                        <div>响应时间: ${instance.responseTime}ms</div>
                        <div class="last-check">最后检查: ${new Date(instance.lastCheckTime).toLocaleString()}</div>
                        ${instance.errorMessage ? `<div class="text-danger">错误: ${instance.errorMessage}</div>` : ''}
                    </p>
                    <button onclick="checkInstance('${instance.instanceId}')" class="btn btn-sm btn-outline-secondary">
                        立即检查
                    </button>
                </div>
            </div>
        `;

        return col;
    }

    // 检查单个实例
    function checkInstance(instanceId) {
        stompClient.send("/app/checkInstance", {}, instanceId);
    }

    // 检查所有实例
    document.getElementById('checkAllBtn').addEventListener('click', function() {
        stompClient.send("/app/checkAllInstances", {});
    });

    // 每60秒自动刷新一次
    setInterval(() => {
        stompClient.send("/app/checkAllInstances", {});
    }, 60000);
</script>
</body>
</html>